{{> header title="Π Wide Area Network - Network"}}
<link rel="stylesheet" href="./assets/clock.css">
<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--12-col text-white center-items">
        <h3 class="text-white">π Wide Area Network - Control Panel</h3>
    </div>
    <div class="mdl-cell mdl-cell--12-col text-white center-items">
        <div class="text-white">We Flight , Receive , and Stamp On Same Time</div>
        <div class="text-white">PiWAN is now still running under sandboxed Test Net</div>
        <div class="digital-clock"></div>
        <div class="clock">
            <div class="outer-clock-face">
                <div class="marking marking-one"></div>
                <div class="marking marking-two"></div>
                <div class="marking marking-three"></div>
                <div class="marking marking-four"></div>
                <div class="inner-clock-face">
                    <div class="hand hour-hand"></div>
                    <div class="hand min-hand"></div>
                    <div class="hand second-hand"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="mdl-cell mdl-cell--4-col text-white">
        <div class="mdl-card" style="width: 100%;">
            <div class="mdl-card__title">
                <h5 class="text-black">π-tm</h5>
            </div>
            <div class="mdl-card__supporting-text">
                <div class="text-black">Piwan Times Message Network Protocol Timestamp</div>
                <div class="text-black">Network Time Based On Collective Nodes Packet</div>
                <div class="text-black">π-tm  IPv4 Address : {{client_ip}}</div>
                <div class="text-black">π-tm running : {{tms_running}}</div>
            </div>
            <div class="mdl-card__actions">

            </div>
        </div>
    </div>
    <div class="mdl-cell mdl-cell--4-col text-white">
        <div class="mdl-card" style="width: 100%;">
            <div class="mdl-card__title">
                <h5 class="text-black">πwan-udp</h5>
            </div>
            <div class="mdl-card__supporting-text">
                <div class="text-black">πwan-udp node address : {{client_ip}}</div>
                <div class="text-black">πwan-udp node running : {{udp_running}}</div>
            </div>
            <div class="mdl-card__actions">

            </div>
        </div>

    </div>
    <div class="mdl-cell mdl-cell--4-col text-white">
        <div class="mdl-card" style="width: 100%;">
            <div class="mdl-card__title">
                <h5 class="text-black">πwan-tcp</h5>
            </div>
            <div class="mdl-card__supporting-text">
                <div class="text-black">πwan-tcp node address : {{client_ip}}</div>
                <div class="text-black">πwan-tcp node running : {{udp_running}}</div>
            </div>
            <div class="mdl-card__actions">

            </div>
        </div>
    </div>
    <div class="mdl-cell mdl-cell--12-col text-white">
        <div class="mdl-card" style="width: 100%;">
            <div class="mdl-card__title">
                <h5 class="text-black">Log Audit</h5>
            </div>
            <div class="mdl-card__supporting-text" style="height: 150px;">
                <span id="logger" style="height: 120px;" class="text-black"></span>
            </div>
        </div>
    </div>
</div>
<script>
    var now = new Date();
    var pingTimeout;
    const Logger = document.querySelector('#logger');
    const LogArr = [];
    function Render() {
        let str = LogArr.shift();
        const para = document.createElement("div");
        para.innerHTML = `${now.getTime()} : ${str}`;
        if (Logger.childElementCount <= 7) {
            Logger.appendChild(para);
        } else {
            Logger.removeChild(Logger.children[0]);
            Logger.removeChild(Logger.children[1]);
        }

    }
    function LOG_HTML(str) {
        LogArr.push(str);
        Render();
    }
    function hexToBytes(hex) {
        let bytes = [];
        for (let c = 0; c < hex.length; c += 2)
            bytes.push(parseInt(hex.substr(c, 2), 16));
        return bytes;
    }


    function heartbeat() {
        clearTimeout(this.pingTimeout);

        // Use `WebSocket#terminate()`, which immediately destroys the connection,
        // instead of `WebSocket#close()`, which waits for the close timer.
        // Delay should be equal to the interval at which your server
        // sends out pings plus a conservative assumption of the latency.
        this.pingTimeout = setTimeout(() => {
            this.terminate();
        }, 1000 + 1000);
    }

    const secondHand = document.querySelector('.second-hand');
    const minsHand = document.querySelector('.min-hand');
    const hourHand = document.querySelector('.hour-hand');
    const digitalclock = document.querySelector('.digital-clock');
    function setDate() {
        const seconds = now.getSeconds();
        const secondsDegrees = ((seconds / 60) * 360) + 90;
        secondHand.style.transform = `rotate(${secondsDegrees}deg)`;

        const mins = now.getMinutes();
        const minsDegrees = ((mins / 60) * 360) + ((seconds / 60) * 6) + 90;
        minsHand.style.transform = `rotate(${minsDegrees}deg)`;

        const hour = now.getHours();
        const hourDegrees = ((hour / 12) * 360) + ((mins / 60) * 30) + 90;
        hourHand.style.transform = `rotate(${hourDegrees}deg)`;

        digitalclock.innerHTML = now.toISOString();
        LOG_HTML("Sync Clock To Network Time");
    }

    try {
        const ws = new WebSocket('ws://localhost');
        ws.onopen = function (e) {
            console.log("Opened Yay");
        };

        ws.onmessage = (event) => {
            let buf = hexToBytes(String(event.data));
            let header = new Uint8Array(4);
            for (i = 0; i < 4; i++) {
                header[i] = buf[i];
            }
            var str = String.fromCharCode.apply(null, header);

            LOG_HTML(`Receive Packet Header ${str}, lenght : ${event.data.length}`);
            let arr = new Uint8Array(8);
            for (i = 0; i < 8; i++) {
                arr[i] = buf[i + 4];
            }
            let view = new DataView(arr.buffer, 0);
            let result = view.getBigUint64(0, true);
            now = new Date(Number(result));
            setDate();
        };

        ws.onclose = function (event) {
            clearTimeout(this.pingTimeout);
            if (event.wasClean) {

            } else {
                // e.g. server process killed or network down
                // event.code is usually 1006 in this case

            }
        };

        ws.onerror = function (error) {
            console.log(error);
        };

        ws.onping = ()=>{
            LOG_HTML("WebSocket HeartBeat");
            heartbeat();
        }
    } catch (e) {
        console.log(e);
    }





</script>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>Pi.init({ version: "2.0",sandbox:true})</script>
{{> footer}}